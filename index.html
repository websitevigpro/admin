<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard Landing</title>

<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  label { font-weight: bold; display: block; margin-top: 10px; }
  input, textarea { width: 100%; padding: 8px; margin-top: 5px; }
  button { padding: 8px 14px; margin-top: 10px; cursor: pointer; }
  .item-box { border: 1px solid #ccc; padding: 8px; margin-top: 8px; }
  img { max-width: 200px; margin-top: 10px; }

  /* LOADING OVERLAY */
  #loading {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(255,255,255,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 99999;
  }
  .spinner {
    width: 60px;
    height: 60px;
    border: 6px solid #ddd;
    border-top-color: #0284fe;
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<div id="loading"><div class="spinner"></div></div>

<h2>Dashboard Landing</h2>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwmmWq-O3YjT_jaGLIh8EQqSYXgHHAO0B0Omj66iTFwVP5oWRBsmTibOv2yJlMX6OJzXg/exec";

// ====================== LOADING CONTROL ======================
function showLoading() {
  document.getElementById("loading").style.display = "flex";
}
function hideLoading() {
  document.getElementById("loading").style.display = "none";
}

// ====================== GENERIC JSON POST =====================
async function sendJSON(data) {
  showLoading();
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
      mode: "cors"
    });
    return res.json();
  } catch (e) {
    alert("Gagal mengirim data ke server!");
    console.error(e);
  } finally {
    hideLoading();
  }
}

// ====================== LOAD DATA FROM SERVER ======================
async function loadData() {
  showLoading();
  try {
    const res = await fetch(API_URL + "?t=" + Date.now());
    const data = await res.json();

    // Landing
    document.getElementById("logo_url").value = data.landing.logo_url;
    document.getElementById("slogan").value = data.landing.slogan;
    document.getElementById("deskripsi").value = data.landing.deskripsi;
    document.getElementById("logoPreview").src = data.landing.logo_url || "";

    // Running Teks
    let rt = document.getElementById("runningTeksList");
    rt.innerHTML = "";
    data.runningTeks.forEach((r, i) => {
      rt.innerHTML += `
        <div class="item-box">
          ${r.teks}
          <button onclick="delRunningTeks(${i})">Hapus</button>
        </div>`;
    });

    // Hot News
    let hn = document.getElementById("hotnewsList");
    hn.innerHTML = "";
    data.hotnews.forEach((n, i) => {
      hn.innerHTML += `
        <div class="item-box">
          <b>${n.judul}</b><br>
          ${n.isi}<br>
          <i>${n.tanggal}</i><br>
          Link: ${n.link}<br>
          <button onclick="delHotNews(${i})">Hapus</button>
        </div>`;
    });

    // Sidebar
    let sb = document.getElementById("sidebarList");
    sb.innerHTML = "";
    data.sidebar.forEach((s, i) => {
      sb.innerHTML += `
        <div class="item-box">
          ${s.label} â†’ ${s.target}
          <button onclick="delSidebar(${i})">Hapus</button>
        </div>`;
    });

    // Slider
    let sl = document.getElementById("sliderList");
    sl.innerHTML = "";
    data.slider.forEach((s, i) => {
      sl.innerHTML += `
        <div class="item-box">
          <img src="${s.url}">
          <button onclick="delSlider(${i})">Hapus</button>
        </div>`;
    });

  } catch (e) {
    alert("Gagal mengambil data dari server.");
    console.error(e);
  } finally {
    hideLoading();
  }
}

window.onload = loadData;

// ================= LANDING ==================
function saveLanding() {
  sendJSON({
    action: "saveLanding",
    logo_url: document.getElementById("logo_url").value,
    slogan: document.getElementById("slogan").value,
    deskripsi: document.getElementById("deskripsi").value
  }).then(() => loadData());
}

// ================= RUNNING TEKS ==================
function addRunningTeks() {
  const teks = document.getElementById("rt_teks").value;
  if (!teks) return alert("Isi teks!");
  sendJSON({ action: "addRunningTeks", teks }).then(() => loadData());
}
function delRunningTeks(i) {
  sendJSON({ action: "delRunningTeks", index: i }).then(() => loadData());
}

// ================= HOT NEWS ==================
function addHotNews() {
  sendJSON({
    action: "addHotNews",
    judul: document.getElementById("hn_judul").value,
    isi: document.getElementById("hn_isi").value,
    tanggal: document.getElementById("hn_tanggal").value,
    link: document.getElementById("hn_link").value
  }).then(() => loadData());
}
function delHotNews(i) {
  sendJSON({ action: "delHotNews", index: i }).then(() => loadData());
}

// ================= SIDEBAR ==================
function addSidebar() {
  sendJSON({
    action: "addSidebar",
    label: document.getElementById("sb_label").value,
    target: document.getElementById("sb_target").value
  }).then(() => loadData());
}
function delSidebar(i) {
  sendJSON({ action: "delSidebar", index: i }).then(() => loadData());
}

// ================= SLIDER UPLOAD (MULTIPART) ==================
async function uploadSlider() {
  const file = document.getElementById("sliderFile").files[0];
  if (!file) return alert("Pilih file!");

  const form = new FormData();
  form.append("file", file);

  showLoading();
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: form,
      mode: "cors"
    });
    const result = await res.json();
    alert("Upload selesai!");
  } catch (e) {
    alert("Gagal upload file!");
  } finally {
    hideLoading();
    loadData();
  }
}

// ================= DELETE SLIDER ==================
function delSlider(i) {
  sendJSON({ action: "delSlider", index: i }).then(() => loadData());
}
</script>

<!-- UI ======================= -->

<h3>Landing Page</h3>
<label>Logo URL:</label>
<input id="logo_url">
<img id="logoPreview">

<label>Slogan:</label>
<input id="slogan">

<label>Deskripsi:</label>
<textarea id="deskripsi"></textarea>

<button onclick="saveLanding()">Simpan Landing</button>

<hr>

<h3>Running Teks</h3>
<input id="rt_teks" placeholder="Isi teks">
<button onclick="addRunningTeks()">Tambah</button>
<div id="runningTeksList"></div>

<hr>

<h3>Hot News</h3>
<input id="hn_judul" placeholder="Judul">
<textarea id="hn_isi" placeholder="Isi"></textarea>
<input id="hn_tanggal" placeholder="Tanggal">
<input id="hn_link" placeholder="Link">
<button onclick="addHotNews()">Tambah</button>
<div id="hotnewsList"></div>

<hr>

<h3>Sidebar</h3>
<input id="sb_label" placeholder="Label">
<input id="sb_target" placeholder="Target">
<button onclick="addSidebar()">Tambah</button>
<div id="sidebarList"></div>

<hr>

<h3>Slider</h3>
<input type="file" id="sliderFile">
<button onclick="uploadSlider()">Upload Slider</button>
<div id="sliderList"></div>

<hr>

</body>
</html>
